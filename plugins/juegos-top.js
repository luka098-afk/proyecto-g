function cleanNum(jid) {
  return String(jid || "").replace(/[^0-9]/g, "").trim()
}

function pickRandom(list) {
  return list[Math.floor(Math.random() * list.length)]
}

export default {
  command: ["top"],
  admin: false,

  run: async ({ conn, m, remoteJid, isGroup, participants, text }) => {
    try {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… VALIDAR QUE SEA GRUPO
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (!isGroup) {
        return await conn.sendText(
          remoteJid,
          `âŒ Este comando solo funciona en grupos.`,
          m
        )
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… VALIDAR QUE HAYA TEXTO
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (!text || !text.trim()) {
        return await conn.sendText(
          remoteJid,
          `Por favor, ingrese un texto para hacer un Top 10.\n\n*Ejemplo:*\n.top mÃ¡s guapos\n.top mÃ¡s inteligentes\n.top mÃ¡s graciosos`,
          m
        )
      }

      // Limpiar el texto (quitar el comando si viene incluido)
      text = text.replace(/^\.top\s*/i, '').trim()

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… VALIDAR QUE HAYA SUFICIENTES PARTICIPANTES
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (!participants || participants.length < 10) {
        return await conn.sendText(
          remoteJid,
          `âŒ Se necesitan al menos 10 miembros en el grupo para hacer un Top 10.`,
          m
        )
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ² ELEGIR 10 PERSONAS AL AZAR
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const allJids = participants.map(p => p.id)
      const seleccionados = []

      // Seleccionar 10 personas Ãºnicas
      while (seleccionados.length < 10) {
        const randomJid = allJids[Math.floor(Math.random() * allJids.length)]
        if (!seleccionados.includes(randomJid)) {
          seleccionados.push(randomJid)
        }
      }

      // Asignar posiciones
      const [a, b, c, d, e, f, g, h, i, j] = seleccionados

      // Obtener nÃºmeros limpios
      const nums = seleccionados.map(jid => cleanNum(jid))

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“ MAPEAR JIDS REALES PARA MENCIONES
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const metadata = await conn.groupMetadata(remoteJid)
      const groupParticipants = metadata.participants || []
      
      const realJids = []
      
      for (const selectedJid of seleccionados) {
        const selectedNum = cleanNum(selectedJid)
        let realJid = selectedJid
        
        for (const p of groupParticipants) {
          if (cleanNum(p.id) === selectedNum) {
            realJid = p.id
            break
          }
        }
        
        realJids.push(realJid)
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¨ EMOJI ALEATORIO
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const emoji = pickRandom(['ğŸ¤“','ğŸ˜…','ğŸ˜‚','ğŸ˜³','ğŸ˜', 'ğŸ¥µ', 'ğŸ˜±', 'ğŸ¤‘', 'ğŸ™„', 'ğŸ’©','ğŸ‘','ğŸ¤¨','ğŸ¥´','ğŸ”¥','ğŸ‘‡ğŸ»','ğŸ˜”', 'ğŸ‘€','ğŸŒš'])

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“‹ CREAR MENSAJE DE TOP 10
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const mensaje = `*${emoji} Top 10 ${text} ${emoji}*
    
*1.* @${nums[0]}
*2.* @${nums[1]}
*3.* @${nums[2]}
*4.* @${nums[3]}
*5.* @${nums[4]}
*6.* @${nums[5]}
*7.* @${nums[6]}
*8.* @${nums[7]}
*9.* @${nums[8]}
*10.* @${nums[9]}`

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¤ ENVIAR MENSAJE
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      await conn.sendText(
        remoteJid,
        mensaje,
        m,
        { mentions: realJids }
      )

      console.log(`ğŸ† Top 10 creado: ${text}`)

    } catch (err) {
      console.error(`âŒ Error en top.js:`, err.message)
      console.error(err.stack)

      try {
        await conn.sendMessage(remoteJid, {
          react: { text: 'âš ï¸', key: m.key }
        })
      } catch (e) {
        console.log(`âš ï¸ No se pudo reaccionar: ${e.message}`)
      }
    }
  }
}
